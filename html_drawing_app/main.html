<!DOCTYPE html>
<html>

<head>
<title>drawing/animation app</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="filterslib.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script>
var layerArray = ['canvas0'];
var curPage = 0;
var curCanvas = layerArray[curPage];
</script>
</head>

<style>

#header{
text-align:center;
}

#rightCol{
margin-top: -5%;
text-align:center;
}

#toolbar{
margin: 10px auto;
border: black 1px solid;
padding:2px;
text-align:center;
margin-bottom: 5%;
}

#toolbar button{
margin-bottom: 5px;
padding-left: 2px;
padding-right: 2px;
}

#canvas0{
border: 1px black solid;
}

li{
display:inline-block;
}

#picture{
width: 750px;
margin:0 auto;
text-align:center;
}

#playPanel{
margin: 0 auto;
margin-bottom: 30px;
text-align:center;
}

#footer{
height: 45px;
}

#colorWheel{
border: black solid 1px;
margin: 0 auto;
display: block;
}

#filters{
width: 50%;
margin: 0 auto;
margin-bottom: 5%;
}

.dropdown{
width: 50%;
}

.dropdown-menu{
left: 0;
right: 0;
}

.dropdown-toggle{
width: 100%;
}

.dropdown-menu>li{
display:block;
text-align:center;
}

.dropdown-menu>li:hover{
background-color: #dddeee;
}

#toggleToolbar{
margin-top: 5px;
margin-bottom: 5px;
}
</style>

<body>
<div class='container-fluid'>

<div class='row' id='header'>
	<h1>animation/drawing app</h1>
	<p>link to source code</p>
	<button id='toggleToolbar' class='btn' onclick='toggleToolbar()'> toggle toolbar </button>
	
		<ul>
			<li id='down'><h2><=</h2></li>
			<li><h2 id='count'></h2></li>
			<li id='up'><h2>=></h2></li>
		</ul>

</div>


<div class='row'>		
					
	<div class='col-md-6 col-lg-6 col-lg-offset-3 col-md-offset-3'>
		<div id='picture'>
			<canvas id="canvas0" width='700' height='700' class='canvas'></canvas> 
		</div>
	</div>
	
	<!-- TOOLBAR -->
	<div id='rightCol' class='col-md-3 col-lg-3' style='border: black solid 1px'>

		<h2>toolbar</h2>
		<p>tips:</p>
		<p>-use spacebar to add a new layer!</p>
		<p>-use the arrow keys to go forward or backward!</p>
 
			<div id='toolbar'>
			  <p class="text-info"> general tools </p>
					<button id = 'import' class='btn' onclick='openFile(handleFile)'>import pic</button>
					<input id="fileInput" style="display:none;" type="file">
					<button id='clear' class='btn'>clear</button>
					<button id='reset' class='btn'>reset</button>
					<button id='#ffffff' class ='color btn'>eraser</button>
					<button id='addPage' class='btn'>add another layer</button>
					<button id ='clone' class='btn'> clone current layer</button>
					<p>change brush size</p>
					<input class='brushSize' type='range' min='.5' max='15' step='.5' value='5'>
					<span id='brushSizeValue'> 5.0 </span>
			</div>
			
	
	 <div id='filters' class="dropdown">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			filters <span class="caret"></span>
			</button>
			<ul class="dropdown-menu">
				<li onclick='filterCanvas(grayscale)'>grayscale</li>
				<li onclick='filterCanvas(sepia)'>sepia </li>
				<li onclick='filterCanvas(saturate)'>saturate</li>
				<li onclick='filterCanvas(swap)'>swap</li>
				<li onclick='filterCanvas(banded)'>banded</li>
				<li onclick='filterCanvas(scary)'>scary</li>
				<li onclick='filterCanvas(purpleChrome)'>purpleChrome</li>
				<li onclick='filterCanvas(purplizer)'>purplizer</li>
				<li onclick='filterCanvas(heatwave)'>heatwave</li>
				<li onclick='reset()'>reset</button>
			</ul>
	</div>
		
			<canvas id='colorWheel' height='200' width='200'></canvas>
			<p id='pickedColor'>color picked goes here</p> 
			
			<div id='playPanel'>
				<p class='text-info'>play panel</p>
				<button id='forward' class='btn' onclick = 'playForward()'> => </button>
				<button id='stop' class='btn' onclick = 'stop()'> stop </button>
				<button id='backward' class='btn' onclick='playBackward()'> <= </button>
			</div>
		
		
		</div> <!--end toolbar (right col) -->
 
</div> <!-- end row-->

<div id='footer' class='row'>
</div>

</div> <!--close container -->

<script> 
//check this out! http://perfectionkills.com/exploring-canvas-drawing-techniques/

//for colorWheel
var colorWheel = document.getElementById('colorWheel');
var colorWheelContext = colorWheel.getContext('2d');

var x = colorWheel.width / 2;
var y = colorWheel.height / 2;
var radius = 90;

for(var angle = 0; angle <= 5600; angle++){
	var startAngle = (angle-2)*Math.PI / 180; //convert angles to radians
	var endAngle = (angle)*Math.PI / 180;
	
	colorWheelContext.beginPath();
	colorWheelContext.moveTo(x, y);
	//.arc(x, y, radius, startAngle, endAngle, anticlockwise)
	colorWheelContext.arc(x, y, radius, startAngle, endAngle, false);
	colorWheelContext.closePath();
	
	//use .createRadialGradient to get a different color for each angle
	//createRadialGradient(x0, y0, r0, x1, y1, r1)
	var gradient = colorWheelContext.createRadialGradient(x, y, 0, startAngle, endAngle, radius);
	gradient.addColorStop(0, 'hsla(' + angle + ', 10%, 100%, 1)');
	gradient.addColorStop(1, 'hsla(' + angle + ', 100%, 50%, 1)');
	
	colorWheelContext.fillStyle = gradient;
	colorWheelContext.fill();
}

//pick a color from color wheel

$('#colorWheel').mousedown(function(e){ 
var x = e.offsetX;
var y = e.offsetY;
var colorPicked = colorWheelContext.getImageData(x, y, 1, 1).data;
var colorPickedText = document.getElementById('pickedColor');
colorPickedText.textContent = 'rgb(' + colorPicked[0] + ',' + colorPicked[1] + ',' + colorPicked[2] + ')';
$('#pickedColor').css({'background-color': colorPickedText.textContent});
curColor = 'rgb(' + colorPicked[0] + ',' + colorPicked[1] + ',' + colorPicked[2] + ')';
})


//brush size changer
var brushSize = document.querySelector('.brushSize');
brushSize.oninput = function(){
curSize = brushSize.value;
$('#brushSizeValue').html(brushSize.value);
}

//stuff for the page-count thing at the top
var page = 0;
$('#count').html(curPage);//make sure 0 shows up when page loads



//toggle toolbar
$('#rightCol').hide();
var showToolbar = false;

function toggleToolbar(){
if(!showToolbar){
	$('#rightCol').show();
	showToolbar = true;
}else{
	$('#rightCol').hide();
	showToolbar = false;
}
}




//these gigantic objects will store all the pixel data for each canvas!
//ideally the user might want to go back to a canvas and manipulate that canvas
//this will allow individual canvas manipulation whenever you want.
//the index of each array within dataX or dataY will correspond with the page number.
var dataX = {};
var dataY = {};
var dataColor = {};
var dataDrag = {};
var dataSize = {};

//store ALL coordinates for current canvas 
//declare these variables here for the initial canvas
//the purpose of these current array variables is to allow for canvas cloning
var curClickX = []; 
var curClickY = [];
var curClickColor = [];
var curClickDrag = [];
var curClickSize = [];

//temp arrays store pixel data for current canvas. if you switch frames, these arrays clear.  
var clickX = [];
var clickY = [];
var clickDrag = [];
var clickColor = [];
var clickSize = [];

//new arrays for the click arrays
function clearClick(){
clickX = [];
clickY = [];
clickDrag = [];
clickColor = [];
clickSize = [];
}

//new arrays for the curClick arrays
function clearCurClick(){
curClickX = [];
curClickY = [];
curClickDrag = [];
curClickColor = [];
curClickSize = [];
}

var lbrush = 0; 
var curSize = 5;
var cbrush = 0;
var curColor = '#000000'; //'#df4b26';

var theCanvas = document.getElementById(curCanvas);
var context = theCanvas.getContext("2d");

//set initial canvas bg color to white!
context.fillStyle = "#FFFFFF";
context.fillRect(0,0,theCanvas.width,theCanvas.height);

//define redraw
function redraw(){

context.lineJoin = 'round';

//new kind of brush
/*
function weirdBrush(){
var random = Math.random()*(15-1) + 1;
context.moveTo(clickX[i-1]*random, clickY[i-1]);
context.lineTo(clickX[i]*random, clickY[i]/random);
}
*/

for(var i = 0; i < clickX.length; i++){
  context.beginPath();
  //this helps prevent dragging!!! 
  if(clickDrag[i] && i){ 
  context.moveTo(clickX[i-1], clickY[i-1]);//this might explain buggy crazy brush when copying a canvas. try changing the -1. 
  //context.lineTo(clickX[i], clickY[i]);
  }
  else{
	if(lbrush === 1){
	cbrush = 0;
	context.moveTo(clickX[i], clickY[i]+10);
	}
	else if(cbrush === 1){
	lbrush = 0;
	context.moveTo(clickX[i-2], clickY[i-1]+15);
	context.lineTo(clickX[i], clickY[i]);
	}
	else{
	context.moveTo(clickX[i], clickY[i]+1);
	//context.lineTo(clickX[i], clickY[i]);
	}
  }
  context.lineTo(clickX[i], clickY[i]);
  context.closePath();
  context.strokeStyle = clickColor[i];
  context.lineWidth = clickSize[i]; 
  context.stroke(); 
}
};


function addClick(x, y, dragging){
clickX.push(x);
clickY.push(y);
clickDrag.push(dragging);
clickColor.push(curColor);
clickSize.push(curSize);
curClickX.push(x);
curClickY.push(y);
curClickDrag.push(dragging);
curClickColor.push(curColor);
curClickSize.push(curSize);
}


//#picture is the container of the canvas, so I used #picture to get the top and left coordinates
var offsetTop = $('#picture').position()["top"];  
var offsetLeft = $('#picture').position()["left"];

//define draw 
function draw(){
var paint;
//var rect = theCanvas.getBoundingClientRect();

$('#' + curCanvas).mousedown(function(e){
if(e.which === 1){ //when left click only
paint = true;
var mouseX = e.offsetX;
var mouseY = e.offsetY;
addClick(mouseX, mouseY);
redraw();
}
});

$('#' + curCanvas).mousemove(function(e) {
  if (paint){
     if(cbrush === 1 || lbrush === 1){
	 addClick(e.offsetX, e.offsetY, false);
	 }
	 else{
	 //set dragging to 1 = solid lines when moving the mouse. 
	 addClick(e.offsetX, e.offsetY, true);
	 }
	 redraw();
}
});

$('#' + curCanvas).mouseup(function(e) {
//log new pixel data every time a canvas is drawn on!
pixelData();
paint = false;
if(cbrush === 1){
clearClick();
}
});

$('#' + curCanvas).mouseleave(function(e){
paint = false;
});

$('#clear').click(function(){
context = document.getElementById(curCanvas).getContext("2d");
context.clearRect(0, 0, theCanvas.width, theCanvas.height);
context.fillStyle = "#FFFFFF";
context.fillRect(0,0,theCanvas.width,theCanvas.height);
clearClick();
clearCurClick();
//reset saved pixel data
dataX[curCanvas] = [];
dataY[curCanvas] = [];
dataDrag[curCanvas] = [];
dataColor[curCanvas] = [];
dataSize[curCanvas] = [];
});

$(".color").click(function(){
curColor = this.id;
});

$(".size").click(function(){
curSize = this.id;
});

$("#reset").click(function(){
cbrush = 0;
lbrush = 0;
curSize = 5;
curColor = '#000000'; //default color is black
});


$("#lbrush").click(function(){
clearClick();
lbrush = 1;
cbrush = 0;
});

$("#cbrush").click(function(){
clearClick();
lbrush = 0;
cbrush = 1;
});

};//end draw function

//setting up for adding layers....
var top = $('#canvas0').position()["top"];  
var left = $('#canvas0').position()["left"];

//add a new canvas
$("#addPage").click(addPage);

function addPage(){
page = page + 1;
var canvasClone = $('#canvas0').clone();
var newId = 'canvas' + page;
layerArray.push(newId);
canvasClone.addClass('canvas');
canvasClone.attr('id', newId);
canvasClone.css({"position": "absolute", "top": top+"px", "left": left+"px", "z-index":0, "border": "1px black solid", "opacity":0});
canvasClone.appendTo('#picture');

//set canvas bg color to white!
$('#' + newId)[0].getContext('2d').fillStyle = "#FFFFFF";
$('#' + newId)[0].getContext('2d').fillRect(0,0,theCanvas.width,theCanvas.height);

}

//clone the previous canvas
$("#clone").click(clonePage);

function clonePage(){
page = page + 1;
var canvasClone = $('#' + curCanvas).clone();//cloning the previous canvas only copies the canvas, not what's in it...
var newId = 'canvas' + page;
layerArray.push(newId);
canvasClone.addClass('canvas');
canvasClone.attr('id', newId);
canvasClone.css({"position": "absolute", "top": top+"px", "left": left+"px", "z-index":0, "border": "1px black solid", "opacity":.4});
canvasClone.appendTo('#picture');

//set canvas bg color to white!
$('#' + newId)[0].getContext('2d').fillStyle = "#FFFFFF";
$('#' + newId)[0].getContext('2d').fillRect(0,0,theCanvas.width,theCanvas.height);

//append new cloned canvas id to dataX, dataY objects with cloned pixel data.
dataX[newId] = dataX[curCanvas];
dataY[newId] = dataY[curCanvas];
dataDrag[newId] = dataDrag[curCanvas];
dataColor[newId] = dataColor[curCanvas];
dataSize[newId] = dataSize[curCanvas];

context = document.getElementById(newId).getContext("2d");

//cloning a page should only reflect the pixel data of the current canvas!!
//meaning you have to assign clickX, clickY, etc. => dataX[curPage], dataY[curPage], etc...
clickX = dataX[curCanvas];
clickY = dataY[curCanvas];
clickDrag = dataDrag[curCanvas];
clickColor = dataColor[curCanvas];
clickSize = dataSize[curCanvas];

//redraw with new clickX, etc. data
redraw();
};

//function for storing/modifying pixel data for each canvas
function pixelData(){

if(dataX[curCanvas] === undefined){
dataX[curCanvas] = curClickX;
dataY[curCanvas] = curClickY;
dataColor[curCanvas] = curClickColor;
dataDrag[curCanvas] = curClickDrag;
dataSize[curCanvas] = curClickSize;
}

if(dataX[curCanvas] !== 'undefined' && curClickX.length > 0){
dataX[curCanvas] = dataX[curCanvas].concat(curClickX);
dataY[curCanvas] = dataY[curCanvas].concat(curClickY);
dataColor[curCanvas] = dataColor[curCanvas].concat(curClickColor);
dataDrag[curCanvas] = dataDrag[curCanvas].concat(curClickDrag);
dataSize[curCanvas] = dataSize[curCanvas].concat(curClickSize);
}
}

//UP
function up(){

if(curPage < page){
curPage = curPage + 1;
$('#count').html(curPage);
curCanvas = layerArray[curPage];
$('#' + curCanvas).css({"z-index":10, "opacity": .8}); //if canvas wasn't white, you could set this to 1. but if you keep a white background, curCanvas needs to be somewhat opaque.

context = document.getElementById(curCanvas).getContext("2d");

for(i=0;i<layerArray.length;i++){
if(layerArray[i] !== curCanvas){
$('#' + layerArray[i]).css({"z-index":0,"opacity":0});
$('#' + layerArray[i]).mousedown(function(){ 
paint = false;
})
}
};
//set only the second-to-last canvas a lower opacity
$('#' + layerArray[curPage-1]).css({"z-index":0,"opacity":.6});
}

//reset
//when you leave a frame, reset everything!
clearClick();
clearCurClick();
draw();
}

//DOWN
function down(){

if(curPage > 0){
curPage = curPage - 1;
$('#count').html(curPage);
curCanvas = layerArray[curPage];
$('#' + curCanvas).css({"z-index":10, "opacity": .8});
}

context = document.getElementById(curCanvas).getContext("2d");

for(i=0;i<layerArray.length;i++){
if(layerArray[i] !== curCanvas){
$('#' + layerArray[i]).css({"z-index":0,"opacity":0});
$('#' + layerArray[i]).mousedown(function(){ 
paint = false;
})
}
};
$('#' + layerArray[curPage-1]).css({"z-index":0,"opacity":.6});

//when you leave a frame, reset everything!
clearClick();
clearCurClick();

draw();
};

//COLOR PICKER
$('#setColor').click(function(){
var redValue = $('#red').val(); //.val() is for jquery, .value is for regular ecmascript!
var blueValue = $('#blue').val();
var greenValue = $('#green').val();
var newColor = 'rgb(' + redValue + ',' + greenValue + ',' + blueValue + ')';
$('#showColor').css({'background-color': newColor});
curColor = newColor;
});

$("#up").click(up);
$("#down").click(down);

//keymapping
$(document).keydown(function(e){
switch(e.which){
    case 37: //left arrow key
	down();
	break;
	case 39: //right arrow key
	up();
	break;
	case 32: //space bar
	addPage();
	break;
	default:
	return;
	}
	e.preventDefault();
});

var play;
//functions for animation playback
function playForward(){
play = null;
play = setInterval(up,1000);
}

function playBackward(){
play = null;
//autofocus on last frame
$('#' + layerArray[layerArray.length-1]).css({"z-index":10, "opacity": .8});
curCanvas = layerArray[page];
curPage = page;
//
play = setInterval(down,1000);
}

function stop(){
clearInterval(play);
}

$('#colorBg').click(function(){
for(i = 0;i < 255; i++){ 
context.fillStyle = 'rgb(' + (i-50) + ',' + (i-20) + ',' + (i-10) + ')';
context.fillRect(0,i,theCanvas.width,theCanvas.height);
}
});

$(document).ready(function(){
$('.dropdown-toggle').dropdown();
draw();
});
//end

</script>

</body>


</html>