<!DOCTYPE html>
<html>

<head>
<title>audio player</title>
<meta charset = 'utf-8'>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
</head>

<style>
#player1{
margin-top: 60px;
text-align:center;
border: #DDFDFF solid 2px;
}
#player2{
text-align:center;
margin-top:50px;
border: #EEEFFF solid 2px;
}
#demo{
background-color: blue;
width: 800px;
}
#control, #tools{
margin-top:40px;
text-align:center;
}
body{
background-color: #DDDFFF;
}
</style>

<body>
<div class='container'>

<h1 class='text-center'> audio player 1</h1>

<div id='player1'>
<p> regular HTML5 audio player here </p>
<audio id='demo' src='C:\Documents and Settings\HUNG\Desktop\あすいろ恋模様 full SB69クリティクリスタ.mp3' controls preload='auto'></audio>
<p>name of audio file: </p>
<p id='audioName'></p>

<div id='control'>
<p>some controls go here...</p>
<p>**tip! 'import audio' will import your selected audio file to both the default audio player and to 'audio player 2'. The difference is that 'audio player 2' can manage more interesting manipulations of the audio. ***</p>
</div>
</div>


<div id='player2' class='row'>
	<p>modified audio player using Web Audio API here: (player 2)</p>
    <div id='progressBar'></div>
	<p id='songLength'></p>
	<button id='play' class='btn'>play audio file</button>
	<button id='stop' class='btn'>stop audio file</button>
</div>
	

<div id='tools'>
<h2 class='text-center'>toolbar for modifying audio (player 2)</h2>
<button class='btn' onclick='openFile(handleFile)'>import audio file</button>
<input type='file' id='inputFile' style="display:none;">

<p>Set playback rate</p>
<input class="playback-rate-control" type="range" min="0.25" max="3" step="0.05" value="1">
<span id="playbackValue">1.0</span>

</div>

</div><!--close container -->

<script>
//http://joshondesign.com/p/books/canvasdeepdive/chapter12.html
//https://github.com/mdn/decode-audio-data/blob/gh-pages/index.html
//https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/playbackRate

var audioFile = document.getElementById("demo");
audioFile.playbackRate = 1;

var audioName = document.getElementById("audioName");
var songLength = document.getElementById("songLength");
var myAudio = document.querySelector("audio"); //fetch the html audio element


//variables for manipulating audio

//player2 specific
var progBar;
var ctx;

var buf; //buffer
var fileURL; //this is for holding a 'URL' of a selected file
var source; //buffer source
var audioCtx; //audio context
var duration; //duration of selected track (passed to innerHTML)
var playbackControl = document.querySelector('.playback-rate-control');
var playBar; //set progress bar increment

 
//initialize the sound system
function init(){
 //set audio context
audioCtx = new AudioContext();
source = audioCtx.createBufferSource();
loadFile();
}
//initiate function init() immediately on page load
//window.addEventListener('load',init,false);

//now load and decode sound once sound system initialized
function loadFile(){
	var request = new XMLHttpRequest();
	request.open("GET", fileURL, true);
	request.responseType = 'arraybuffer';
	request.onload = function(){
	
	//decode loaded data
	audioCtx.decodeAudioData(request.response, function(buffer){
		buf = buffer;
		duration = buffer.duration;
		songLength.innerHTML = buffer.duration + " seconds";
		
		//add a progress bar
		var div = document.getElementById('progressBar');
		div.innerHTML = '<canvas id=\'progBar\' height=\'30px\' width=\'' + Math.floor(duration) + 'px\'>' + '</canvas>';	
		progBar = document.getElementById('progBar');
		progBar.style.border = 'solid black 2px';
		ctx = progBar.getContext("2d");
		//create source node from buffer
		source.buffer = buf;
        //attach buffer to your audio context
		//source.connect(audioCtx.destination);
		//allow change to playBack rate by setting value
		source.playbackRate.value = playbackControl.value;
		
		});
	};
	request.send();
}

//increment progress bar 1px every second. 	
var counter = 0;

function timer(){
	counter+=1*playbackControl.value;
	ctx.fillStyle = "green";
    ctx.fillRect(0, 0, counter, 100);
}

//start track play button
var play = document.getElementById('play');
play.onclick = function(){
//attach buffer to your audio context
source.connect(audioCtx.destination);
source.start(0);
playBar = setInterval(timer,1000);
}

//stop track play button
var stop = document.getElementById('stop');
stop.onclick = function(){
source.stop(0);
clearInterval(playBar);
//reset progress bar
ctx.clearRect(0,0, Math.floor(duration), 30);
counter=0;
//re-initialize
init();
}

//allow playback rate to be altered 
playbackControl.oninput = function() {
  if(source !== undefined){
  source.playbackRate.value = playbackControl.value;
  };
  audioFile.playbackRate = playbackControl.value;
  document.getElementById('playbackValue').innerHTML = playbackControl.value;
}


//IMPORTING AUDIO CODE HERE //
var openFile = (function(){
return function(handle){ 
	var fileInput = document.getElementById("inputFile");

	function onFileChange(e){
	var files = e.target.files;
	if(files && files.length>0) //if a file has been selected
	   handle(files)//do some function to that file
	}
	fileInput.addEventListener("change", onFileChange, false);
	fileInput.click(); 
}
})();


function handleFile(files){
var file = files[0];
fileURL = URL.createObjectURL(file);
//process only audio files
var imageType = /audio.*/;
if(!file.type.match(imageType)){
	return;
}

var reader = new FileReader();
reader.onerror = function(e){
alert('Error code ' + e.target.error);
}

//Create a closure (notice modular pattern here) to capture file information
//after the selected file is read, its contents are available and this function is executed
reader.onload = (function(file){  
	return function(evt){
		//attach the name of the file onto the webpage
		audioName.innerHTML = file.name;
		audioFile.src = evt.target.result;
	}
})(file); //make sure file is passed to this function

//read in the file as a data url (why over here though?)
reader.readAsDataURL(file);
audioFile.value = null;
//EXECUTE init() here!
init();
}

</script>

</body>

</html>
